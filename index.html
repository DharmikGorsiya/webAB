<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <title>Unity WebGL AR</title>

  <meta name="viewport"
        content="width=device-width, height=device-height, initial-scale=1.0, user-scalable=no">

  <link rel="stylesheet" href="TemplateData/style.css">
  <link rel="manifest" href="manifest.webmanifest">

  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: black;
      font-family: Arial, sans-serif;
    }

    #unity-container {
      width: 100vw;
      height: 100vh;
      position: relative;
    }

    #startOverlay {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.75);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
      color: white;
      text-align: center;
    }

    #startOverlay button {
      padding: 16px 32px;
      font-size: 18px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      background: #2f80ff;
      color: white;
    }

    #unity-loading-bar {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 60%;
      height: 6px;
      background: #333;
    }

    #unity-progress-bar-full {
      width: 0%;
      height: 100%;
      background: white;
    }
  </style>
</head>

<body>

<div id="unity-container">
  <canvas id="unity-canvas" tabindex="-1"></canvas>

  <div id="unity-loading-bar">
    <div id="unity-progress-bar-full"></div>
  </div>
</div>

<!-- START AR OVERLAY -->
<div id="startOverlay">
  <h2>Web AR Experience</h2>
  <p>This experience requires camera and motion access.</p>
  <button id="btnStartAR">Start AR</button>
</div>

<!-- AR helper scripts -->
<script src="arcamera.js"></script>
<script src="wtracker.js"></script>

<script>
  /******************************************************************
   * UNITY LOADING
   ******************************************************************/
  const buildUrl = "Build";
  const loaderUrl = buildUrl + "/webAB.loader.js";

  const config = {
    dataUrl: buildUrl + "/webAB.data",
    frameworkUrl: buildUrl + "/webAB.framework.js",
    codeUrl: buildUrl + "/webAB.wasm",
    streamingAssetsUrl: "StreamingAssets",
    companyName: "DefaultCompany",
    productName: "WebAR",
    productVersion: "1.0",
    showBanner: (msg, type) => console.log(type, msg)
  };

  let unityInstance = null;

  const script = document.createElement("script");
  script.src = loaderUrl;
  script.onload = () => {
    createUnityInstance(
      document.getElementById("unity-canvas"),
      config,
      (progress) => {
        document.getElementById("unity-progress-bar-full").style.width =
          (progress * 100) + "%";
      }
    ).then((instance) => {
      unityInstance = instance;
      console.log("Unity loaded");
    });
  };
  document.body.appendChild(script);

  /******************************************************************
   * REQUIRED FOR DllImport("__Internal")
   * MUST BE ON window OBJECT
   ******************************************************************/
  window.RequestARPermissionsAndStart = async function () {
    try {
      console.log("Requesting AR permissions...");

      // CAMERA PERMISSION (REQUIRED)
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment" },
        audio: false
      });
      stream.getTracks().forEach(t => t.stop());

      // MOTION PERMISSION (iOS)
      if (typeof DeviceMotionEvent !== "undefined" &&
          typeof DeviceMotionEvent.requestPermission === "function") {
        await DeviceMotionEvent.requestPermission();
      }

      console.log("Permissions granted");

      if (unityInstance) {
        unityInstance.SendMessage(
          "ARBootstrap",
          "OnPermissionsGranted"
        );
      } else {
        console.warn("Unity instance not available yet");
      }

    } catch (err) {
      console.error("Permission denied:", err);
      if (unityInstance) {
        unityInstance.SendMessage(
          "ARBootstrap",
          "OnPermissionsDenied"
        );
      }
    }
  };

  /******************************************************************
   * HTML BUTTON â†’ UNITY SAFE USER GESTURE
   ******************************************************************/
  document.getElementById("btnStartAR").addEventListener("click", () => {
    document.getElementById("startOverlay").style.display = "none";
    window.RequestARPermissionsAndStart();
  });

</script>

</body>
</html>
