<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <title>Unity WebGL AR</title>

  <meta name="viewport"
        content="width=device-width, height=device-height, initial-scale=1.0, user-scalable=no">

  <link rel="stylesheet" href="TemplateData/style.css">
  <link rel="manifest" href="manifest.webmanifest">

  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: black;
      font-family: Arial, sans-serif;
    }

    #unity-container {
      width: 100vw;
      height: 100vh;
      position: relative;
    }

    #startOverlay {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.75);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
      color: white;
      text-align: center;
    }

    #startOverlay button {
      padding: 16px 32px;
      font-size: 18px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      background: #2f80ff;
      color: white;
    }

    #unity-loading-bar {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 60%;
      height: 6px;
      background: #333;
      display: none; /* Hidden until Unity starts loading */
    }

    #unity-progress-bar-full {
      width: 0%;
      height: 100%;
      background: white;
    }
    
    #unity-canvas {
      opacity: 0; /* Hide canvas until loaded */
    }
    
    #startOverlay.loading {
      pointer-events: none; /* Disable button clicks while loading */
    }
    
    #startOverlay.loading button {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>

<body>

<div id="unity-container">
  <canvas id="unity-canvas" tabindex="-1"></canvas>

  <div id="unity-loading-bar">
    <div id="unity-progress-bar-full"></div>
  </div>
</div>

<!-- START AR OVERLAY -->
<div id="startOverlay">
  <h2>Web AR Experience</h2>
  <p>This experience requires camera and motion access.</p>
  <button id="btnStartAR">Start AR</button>
</div>

<!-- AR helper scripts -->
<script src="arcamera.js"></script>
<script src="wtracker.js"></script>

<script>
  /******************************************************************
   * UNITY LOADING
   ******************************************************************/
  const buildUrl = "Build";
  const loaderUrl = buildUrl + "/webAB.loader.js";

  const config = {
    dataUrl: buildUrl + "/webAB.data",
    frameworkUrl: buildUrl + "/webAB.framework.js",
    codeUrl: buildUrl + "/webAB.wasm",
    streamingAssetsUrl: "StreamingAssets",
    companyName: "DefaultCompany",
    productName: "WebAR",
    productVersion: "1.0",
    showBanner: (msg, type) => console.log(type, msg)
  };

  let unityInstance = null;
  let isUnityLoading = false;
  
  // Flag to prevent automatic permission requests - must be set by user interaction
  window._userInitiatedARRequest = false;

  // Function to start loading Unity (only called after button click)
  function startUnityLoading() {
    if (isUnityLoading) {
      console.log("Unity is already loading");
      return;
    }
    
    isUnityLoading = true;
    console.log("Starting Unity loading...");
    
    // Show loading bar
    document.getElementById("unity-loading-bar").style.display = "block";
    
    // Add loading class to overlay to disable button
    const overlay = document.getElementById("startOverlay");
    overlay.classList.add("loading");
    
    // Update overlay text
    const button = document.getElementById("btnStartAR");
    if (button) {
      button.textContent = "Loading...";
    }

    const script = document.createElement("script");
    script.src = loaderUrl;
    script.onload = () => {
      createUnityInstance(
        document.getElementById("unity-canvas"),
        config,
        (progress) => {
          document.getElementById("unity-progress-bar-full").style.width =
            (progress * 100) + "%";
        }
      ).then((instance) => {
        unityInstance = instance;
        console.log("Unity loaded");
        
        // Hide loading bar and show canvas
        document.getElementById("unity-loading-bar").style.display = "none";
        document.getElementById("unity-canvas").style.opacity = "1";
        
        // Now request permissions (Unity is ready)
        window.RequestARPermissionsAndStart();
      }).catch((error) => {
        console.error("Unity loading failed:", error);
        overlay.classList.remove("loading");
        if (button) {
          button.textContent = "Start AR";
          button.style.opacity = "1";
        }
        alert("Failed to load Unity. Please refresh the page.");
      });
    };
    script.onerror = () => {
      console.error("Failed to load Unity loader script");
      overlay.classList.remove("loading");
      if (button) {
        button.textContent = "Start AR";
        button.style.opacity = "1";
      }
      alert("Failed to load Unity. Please refresh the page.");
    };
    document.body.appendChild(script);
  }

  /******************************************************************
   * REQUIRED FOR DllImport("__Internal")
   * MUST BE ON window OBJECT
   * Only call this from user interaction (button click)
   ******************************************************************/
  window.RequestARPermissionsAndStart = async function () {
    // Prevent automatic calls - only allow from button click
    if (!window._userInitiatedARRequest) {
      console.warn("RequestARPermissionsAndStart called without user interaction. Ignoring.");
      return;
    }
    
    // Reset the flag (but keep it if Unity is still loading)
    if (unityInstance) {
      window._userInitiatedARRequest = false;
    }
    
    try {
      console.log("Requesting AR permissions...");

      // CAMERA PERMISSION (REQUIRED)
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment" },
        audio: false
      });
      stream.getTracks().forEach(t => t.stop());

      // MOTION PERMISSION (iOS)
      if (typeof DeviceMotionEvent !== "undefined" &&
          typeof DeviceMotionEvent.requestPermission === "function") {
        await DeviceMotionEvent.requestPermission();
      }

      console.log("Permissions granted");

      if (unityInstance) {
        // Hide overlay now that permissions are granted
        document.getElementById("startOverlay").style.display = "none";
        document.getElementById("unity-canvas").style.opacity = "1";
        
        unityInstance.SendMessage(
          "ARBootstrap",
          "OnPermissionsGranted"
        );
      } else {
        console.warn("Unity instance not available yet - permissions granted but waiting for Unity");
      }

    } catch (err) {
      console.error("Permission denied:", err);
      
      // Re-enable the button
      const overlay = document.getElementById("startOverlay");
      overlay.classList.remove("loading");
      const button = document.getElementById("btnStartAR");
      if (button) {
        button.textContent = "Start AR";
        button.style.opacity = "1";
      }
      
      if (unityInstance) {
        unityInstance.SendMessage(
          "ARBootstrap",
          "OnPermissionsDenied"
        );
      } else {
        // If Unity hasn't loaded yet, show error
        alert("Camera permission is required for AR experience. Please allow camera access and try again.");
      }
      
      window._userInitiatedARRequest = false;
    }
  };

  /******************************************************************
   * HTML BUTTON â†’ UNITY SAFE USER GESTURE
   ******************************************************************/
  // Wait for DOM to be ready before attaching event listener
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupARButton);
  } else {
    setupARButton();
  }
  
  function setupARButton() {
    const btnStartAR = document.getElementById("btnStartAR");
    if (btnStartAR) {
      btnStartAR.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        // Prevent multiple clicks
        if (isUnityLoading) {
          return;
        }
        
        // Mark that this is a user-initiated request
        window._userInitiatedARRequest = true;
        
        // Start loading Unity first
        startUnityLoading();
      });
    } else {
      console.error("btnStartAR button not found!");
    }
  }

</script>

</body>
</html>
